#!/usr/bin/env bash
set -euo pipefail

# ====== Config ======
RUNTIME_DIR="${XDG_RUNTIME_DIR:-/tmp}"
BASE="$RUNTIME_DIR/eww-playerctl"
IMG="$BASE/art.jpg"
URL_CACHE="$BASE/art.url"

mkdir -p "$BASE"

# ====== Get metadata ======
# Output format: title|artist|album|status
metadata="$(playerctl metadata --format '{{xesam:title}}|{{xesam:artist}}|{{xesam:album}}|{{status}}' 2>/dev/null || echo '|||Stopped')"

# ====== Get album art URL ======
ART_URL="$(playerctl metadata --format '{{mpris:artUrl}}' 2>/dev/null || true)"

# ====== Handle album art caching ======
if [ -n "$ART_URL" ]; then
    # Only update if changed
    if [ ! -f "$URL_CACHE" ] || [ "$(cat "$URL_CACHE")" != "$ART_URL" ]; then
        echo "$ART_URL" > "$URL_CACHE"

        if [[ "$ART_URL" == file://* ]]; then
            cp -f "${ART_URL#file://}" "$IMG"
        else
            curl -fsSL "$ART_URL" -o "$IMG"
        fi
    fi
fi

# Ensure album art path always exists
[ ! -f "$IMG" ] && touch "$IMG"

# ====== Output ======
# Metadata and album art path, pipe-separated
echo "$metadata|$IMG"
