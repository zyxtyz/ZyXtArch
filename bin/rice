#!/bin/sh

# =====================================================================
#    __________       ____  ___ __     _____                .__     
#    \____    /___.__.\   \/  //  |_  /  _  \_______   ____ |  |__  
#      /     /<   |  | \     /\   __\/  /_\  \_  __ \_/ ___\|  |  \ 
#     /     /_ \___  | /     \ |  | /    |    \  | \/\  \___|   Y  \
#    /_______ \/ ____|/___/\  \|__| \____|__  /__|    \___  >___|  /
#            \/\/           \_/             \/            \/     \/ 
#
#	Author: Zyxtyz 
#	Repo: https://github.com/zyxtyz/ZyXtArch
#
# =====================================================================

ZYXTARCH_DIR="$HOME/.config/zyxtarch"
[ -f "$ZYXTARCH_DIR/colors/colors.sh" ] && source "$ZYXTARCH_DIR"/colors/colors.sh

# ---------------------------------------------------------------------
# Open config files
# ---------------------------------------------------------------------
edit() {
	cat <<EOF
================================================
1) EWW
2) BSPWM
3) ZSH
================================================
EOF

	read -p "> " answer

	case "$answer" in
		1) nvim "$ZYXTARCH_DIR/eww" ;;
		2) nvim "$ZYXTARCH_DIR/bspwm" ;;
		3) nvim "$ZYXTARCH_DIR/zsh" ;;
		*) nvim "$ZYXTARCH_DIR" ;;
	esac
}

# ---------------------------------------------------------------------
# Apply wallpaper + pywal theme
# ---------------------------------------------------------------------
applywal() {
	if [ -z "$1" ]; then
        echo "Usage: rice wal <image-path-or-url>"
        return 1
    fi

    image="$1"

    # Check if the argument is a URL
    if echo "$image" | grep -Eq '^https?://'; then
        tmpfile="/tmp/$(basename "$image")"
        echo "Downloading $image to $tmpfile..."
            echo "‚ùå Failed to download $image"
            return 1
        
        image="$tmpfile"
    else
        # Make relative paths absolute
        image="$(realpath "$image" 2>/dev/null || echo "$image")"
    fi

    if [ ! -f "$image" ]; then
        echo "‚ùå File not found: $image"
        return 1
    fi

    WALLUST_config_FILE="$ZYXTARCH_DIR"/wallust/config.toml
    WALLUST_TEMPLATES="$ZYXTARCH_DIR"/wallust/templates
    WALLUST_CONFIG="$ZYXTARCH_DIR"/wallust

    feh --bg-fill "$image"
    wallust run "$image" -d $WALLUST_CONFIG 
    bspc config normal_border_color "$color1"
    bspc config active_border_color "$color2"
    bspc config focused_border_color "$color15"
}
#--------------------------------------------------------------------
# set cursor globally (x11)
#--------------------------------------------------------------------
setcursor() {
    CURSOR_PATH="$1"
    CURSOR_SIZE="${2:-24}"  # default size 24 if not specified

    if [ -z "$CURSOR_PATH" ]; then
        echo "Usage: rice cursor <zip-or-dir> [size]"
        return 1
    fi

    # Handle zip file
    if [ -f "$CURSOR_PATH" ] && echo "$CURSOR_PATH" | grep -qE '\.zip$'; then
        TMPDIR=$(mktemp -d)
        echo "üì¶ Unzipping $CURSOR_PATH to $TMPDIR..."
        unzip -q "$CURSOR_PATH" -d "$TMPDIR" || { echo "‚ùå Failed to unzip"; return 1; }
        CURSOR_DIR="$TMPDIR"
    elif [ -d "$CURSOR_PATH" ]; then
        CURSOR_DIR="$CURSOR_PATH"
    else
        echo "‚ùå Not a valid zip or directory: $CURSOR_PATH"
        return 1
    fi

    THEME_NAME=$(basename "$CURSOR_DIR")

    echo "üìÅ Installing cursor theme '$THEME_NAME' to /usr/local/share/cursors/..."
    sudo mkdir -p /usr/local/share/cursors/
    sudo cp -r "$CURSOR_DIR" "/usr/local/share/cursors/$THEME_NAME"

    echo "üîß Setting XCURSOR_THEME=$THEME_NAME and size=$CURSOR_SIZE..."

    # Ensure ~/.xprofile exists
    [ ! -f "$HOME/.xprofile" ] && touch "$HOME/.xprofile"

    # Add or update XCURSOR_THEME
    if grep -q "XCURSOR_THEME" "$HOME/.xprofile" 2>/dev/null; then
        sed -i "s/^export XCURSOR_THEME=.*/export XCURSOR_THEME=$THEME_NAME/" "$HOME/.xprofile"
    else
        echo "export XCURSOR_THEME=$THEME_NAME" >> "$HOME/.xprofile"
    fi

    # Add or update XCURSOR_SIZE
    if grep -q "XCURSOR_SIZE" "$HOME/.xprofile" 2>/dev/null; then
        sed -i "s/^export XCURSOR_SIZE=.*/export XCURSOR_SIZE=$CURSOR_SIZE/" "$HOME/.xprofile"
    else
        echo "export XCURSOR_SIZE=$CURSOR_SIZE" >> "$HOME/.xprofile"
    fi

    # Apply immediately for current session
    export XCURSOR_THEME="$THEME_NAME"
    export XCURSOR_SIZE="$CURSOR_SIZE"
    xsetroot -cursor_name left_ptr

    echo "‚úÖ Cursor theme '$THEME_NAME' installed and applied."
    echo "Logout/login to fully apply in all applications."

    # Cleanup temp unzip if used
    [ -n "$TMPDIR" ] && rm -rf "$TMPDIR"
}

#--------------------------------------------------------------------
# set font global
#--------------------------------------------------------------------
setfontglobal() {
    FONTFILE="$1"

    if [ -z "$FONTFILE" ]; then
        echo "Usage: rice font <fontfile>"
        return 1
    fi

    echo "üì¶ Installing $FONTFILE to /usr/local/share/fonts..."
    sudo mkdir -p /usr/local/share/fonts
    sudo cp "$FONTFILE" /usr/local/share/fonts/

    BASENAME=$(basename "$FONTFILE")

    echo "üîß Writing fontconfig override..."
    sudo tee /etc/fonts/local.conf >/dev/null <<EOF
<?xml version="1.0"?>
<!DOCTYPE fontconfig SYSTEM "fonts.dtd">
<fontconfig>

    <match target="scan">
        <test name="file" compare="eq">
            <string>/usr/local/share/fonts/$BASENAME</string>
        </test>
        <edit name="family" mode="assign" binding="strong">
            <string>Cartograph CF DemiBoldItalic</string>
        </edit>
        <edit name="style" mode="assign" binding="strong">
            <string>DemiBoldItalic</string>
        </edit>
    </match>

    <match target="pattern">
        <edit name="family" mode="assign">
            <string>Cartograph CF DemiBoldItalic</string>
        </edit>
    </match>

    <match target="pattern">
        <edit name="style" mode="assign">
            <string>DemiBoldItalic</string>
        </edit>
    </match>

</fontconfig>
EOF

    echo "üîÑ Rebuilding font cache..."
    sudo fc-cache -f

    echo "‚úÖ Done. Your system is now forced to use DemiBoldItalic everywhere."
    echo "Test with: fc-match"
}
   
# ---------------------------------------------------------------------
# Main script logic
# ---------------------------------------------------------------------
if [ -z "$1" ]; then
	echo "Usage: rice <option> [argument (for wal, font, cursor)]"
	exit 1
fi

case "$1" in
	-h | --help) cat <<EOF

	Usage: rice <option> [argument if needed]

	options:
	[
		edit
		wal
		font
        cursor
	]
	arguments:
	[
		wal <wallpaper>
		font <fontfile>
        cursor <dir/zip>
	]
EOF
;;
	edit)
		edit
		;;
	wal)
		applywal "$2"
		;;
	font)
		setfontglobal "$2"
		;;
    cursor)
        setcursor "$2"
        ;;
	*)
		echo "Unknown option: $1"
		echo "Available options: edit, wal, font, cursor"
		;;
esac